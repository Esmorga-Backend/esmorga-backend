name: When Main Changes
run-name: Testing and Deploying new code to QA Env ðŸš€
on:
  push:
    branches:
    - main

jobs:
  Run-Unit-Tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: ./.github/actions/runUnitTests
        env:
          NODE_ENV: LOCAL

      - name: Run Service
        uses: ./.github/actions/runService
        env:
          MONGODB_URI: ${{secrets.MONGODB_URI}}
          NODE_ENV: ${{vars.NODE_ENV}}
          JWT_SECRET: ${{secrets.JWT_SECRET}}
          ACCESS_TOKEN_TTL: ${{vars.ACCESS_TOKEN_TTL}}
          MAX_PAIR_OF_TOKEN: ${{vars.MAX_PAIR_OF_TOKEN}}
          EMAIL_USER: ${{vars.EMAIL_USER}}
          EMAIL_PASS: ${{secrets.EMAIL_PASS}}
          APP_PORT: ${{vars.APP_PORT}}
          APP_LINK: ${{vars.APP_LINK}}
          LOGIN_ATTEMPTS_TTL: ${{vars.LOGIN_ATTEMPTS_TTL}}
          MAX_LOGIN_ATTEMPTS: ${{vars.MAX_LOGIN_ATTEMPTS}}
          DNS_NAME: ${{vars.DNS_NAME}}
          JWT_REFRESH_SECRET: ${{secrets.JWT_REFRESH_SECRET}}

      - name: Run Postman Tests
        uses: ./.github/actions/runPostmanTests
        with:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          POSTMAN_TOKEN: ${{ secrets.POSTMAN_TOKEN }}
          DESPOSABLE_EMAIL_USER: ${{secrets.DESPOSABLE_EMAIL_USER}}
          DESPOSABLE_EMAIL_PASS: ${{secrets.DESPOSABLE_EMAIL_PASS}}

  DeployToQA:
    needs: Run-Unit-Tests
    uses: ./.github/workflows/Deploy.yml
    secrets: inherit
    with:
      environment: QA
