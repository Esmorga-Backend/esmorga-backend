name: Check vars & secrets
on:
  workflow_call:

jobs:
  setup-secrets:
    runs-on: ubuntu-latest

    steps:
    - name: GET HEAD REF
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
    - name: Preare system
      shell: bash
      run: |
        npm ci

    - name: Get vars or secrets needed to run
      shell: bash
      run: |
        python -m pip install --upgrade pip ruamel.yaml gitpython
        python .github/workflows/scripts/CheckEnv.py ${{secrets.PAT}}



    - name: Configure Git
      if: failure()
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AUTO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        git remote set-url origin git@github.com:Esmorga-Backend/esmorga-backend.git
        git config --global user.email "pablo.canarte.accenture@gmail.com"
        git config --global user.name "EsmorgaPipeBot"
        git add .github/workflows/*.yml
        git commit -m "Update VARS from GitHub Actions"
        git push --force-with-lease origin HEAD:refs/heads/${GITHUB_HEAD_REF}

    - name: Start MongoDB
      uses: supercharge/mongodb-github-action@1.11.0
      with:
        mongodb-version: '7.0'
        mongodb-db: esmorga
        mongodb-port: 27017

    - uses: actions/setup-node@v4
      with:
        node-version: '22.1'
    - run: npm ci

    - name: Run Service
      uses: ./.github/actions/runService
      env:
        MONGODB_URI: ${{secrets.MONGODB_URI}}
        NODE_ENV: ${{vars.NODE_ENV}}
        JWT_SECRET: ${{secrets.JWT_SECRET}}
        ACCESS_TOKEN_TTL: ${{vars.ACCESS_TOKEN_TTL}}
        MAX_PAIR_OF_TOKEN: ${{vars.MAX_PAIR_OF_TOKEN}}
        EMAIL_USER: ${{vars.EMAIL_USER}}
        EMAIL_PASS: ${{secrets.EMAIL_PASS}}
        APP_PORT: ${{vars.APP_PORT}}
        APP_LINK: ${{vars.APP_LINK}}

    - name: Push OAS
      uses: ./.github/actions/pushOasFile
      with:
        AUTO_SSH_PRIVATE_KEY: ${{ secrets.AUTO_SSH_PRIVATE_KEY }}