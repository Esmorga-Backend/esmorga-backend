name: Check vars & secrets
on:
  workflow_call:

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: GET HEAD REF
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}

    - name: Get vars or secrets needed to run 
      shell: bash
      run: |
        python -m pip install --upgrade pip ruamel.yaml gitpython
        python .github/workflows/scripts/CheckEnv.py ${{secrets.PAT}}


    - name: Configure Git
      if: failure()
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AUTO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        git remote set-url origin git@github.com:Esmorga-Backend/esmorga-backend.git
        git config --global user.email "pablo.canarte.accenture@gmail.com"
        git config --global user.name "EsmorgaPipeBot"
        git add .github/workflows/*.yml
        git commit -m "Update VARS from GitHub Actions"
        git push --force-with-lease origin HEAD:refs/heads/${GITHUB_HEAD_REF}

