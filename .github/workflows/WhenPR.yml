name: Run  Unit & Component Tests
run-name: ${{ github.actor }} is testing PR ${{ github.ref }} new code ðŸš€
on:
  pull_request:
    types: [opened,reopened,edited,synchronize]
    branches:
      - main
    paths:
      - '**'
  workflow_dispatch:
    
    
jobs:
    Run-tests-on-Ubuntu:
      name: Run npm test on Ubuntu
      runs-on: ubuntu-latest
      permissions:
        contents: write
        pull-requests: write
      env:
        APP_PORT: 3000
        MONGODB_URI: "mongodb://localhost:27017/esmorga"
        NODE_ENV: LOCAL"
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ACCESS_TOKEN_TTL: 600
        MAX_PAIR_OF_TOKEN: 5
        AIO_TOKEN: ${{ secrets.AIO_TOKEN }}
        CYPRESS_BASE_URL: http://localhost:3000/
        POSTMAN_TOKEN: ${{ secrets.postmanToken }}
        DNS_NAME: http://localhost:3000
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      steps:
        - name: Start MongoDB
          uses: supercharge/mongodb-github-action@1.11.0
          with:
            mongodb-version: '7.0'
            mongodb-db: esmorga
            mongodb-port: 27017
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
          with:
            node-version: '22.1'
        - run: npm ci
        - run: npm run test:create:cycle
        - name: Checkout repository
          uses: actions/checkout@v2
        - name: Run Unit Tests
          uses: ./.github/actions/runUnitTests
          with:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        - name: Run Component Tests
          uses: ./.github/actions/runComponentTests
          with:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        - name: Run Service
          uses: ./.github/actions/runService
        - name: Run Postman
          uses: ./.github/actions/runPostmanTests
          with:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
            POSTMAN_TOKEN: ${{ secrets.POSTMAN_TOKEN }}
        - name: Run E2E Tests
          uses: ./.github/actions/runE2ETests
          with:
                SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        - name: Run Reporting
          uses: ./.github/actions/runReporting
          with: 
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        - name: Push OAS
#          uses: ./.github/actions/pushOasFile
#          with: 
#            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        - name: Checkout del cÃ³digo
          uses: actions/checkout@v3
          with:
            ref: ${{ github.head_ref }}
        - name: Push OAS to github
          shell: bash
          run: |
            echo "Push=0" >> $GITHUB_ENV
            echo ${GITHUB_HEAD_REF} > /tmp/branch.txt
            curl http://127.0.0.1:3000/swagger-json -o /tmp/swagger.json
        - name: Push OAS to github
          shell: bash
          run: |
            if ! cmp -s "/tmp/swagger.json" "swagger.json"; then
            cp /tmp/swagger.json swagger.json
            git add swagger.json
            echo "Swagger has Changed"
            echo "Push=1" >> $GITHUB_ENV
            fi
        - name: Push OAS to github
          shell: bash
          run: |
            if ! cmp -s "/tmp/branch.txt" ".github/tmp/branch.txt" ; then
            cp /tmp/branch.txt .github/tmp/branch.txt
            git add .github/tmp/branch.txt
            echo "Branch has Changed"
            echo "Push=1" >> $GITHUB_ENV
            fi
        - name: Push OAS to github
          shell: bash
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            if [ ${{ env.Push }} != 0 ] ; then
            echo "Run AutoCommit"
            git config --global user.email "devops@esmorga.canarte.org"
            git config --global user.name "Pipe"
            git commit -m "ADD Files"
            git push origin HEAD:${{ github.head_ref }}
            #git push origin HEAD:refs/heads/${GITHUB_HEAD_REF}
            #git push --force-with-lease origin HEAD:refs/heads/${GITHUB_HEAD_REF}
            #git push https://${{ github.actor }}:${{ inputs.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:refs/heads/${GITHUB_HEAD_REF}
            fi
      


